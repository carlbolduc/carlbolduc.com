[% title = 'Carl Bolduc - Deploying Rails to production' %]
<!DOCTYPE html>
<html>
[% INCLUDE head.tt2 | indent(4)  %]
    <body>
[% INCLUDE header_en.tt2 | indent(8) %]
        <main class="longform">
            <h1>Deploying Rails to production</h1>
            <p>I recently launched <a href="https://quinielanacimiento.com.mx">Quiniela de Nacimiento</a> for one of my clients. It was the first Rails application that I was putting in production. Here, you will find all the technical details of how to deploy and run a Rails application on a Linux server. Most of the tutorials I could find online were focussing on deploying to (<a href="https://www.heroku.com">Heroku</a> or using automation tool such as <a href="http://capistranorb.com">Capistrano</a>. My approach is different as I installed the various pieces by hand. Some of the steps are specific to AWS since the server is an EC2 instance and the database is hosted in RDS.</p>

            <h2>Create your production database</h2>
            <p>Create a PostgreSQL instance in RDS. The instructions are detailed <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_GettingStarted.CreatingConnecting.PostgreSQL.html">here</a>.</p>

            <h2>Booting your new server</h2>
            <p>Create an EC2 instance in AWS based on the Ubuntu Server 16.04 LTS AMI. LTS releases are supported for five years by Canonical and Ubuntu Server is widely used. In my experience, it’s easier to find answers on the web when faced with a problem than if you’re using another Linux distribution.</p>

            <h2>Prepare your new server</h2>

            <h3>Environment variables</h3>
            <p>Edit <code>/etc/environment</code> to include the credentials and other sensitive data that are used by your rails application.</p>

            <h3>Software prerequesite</h3>
            <p>Update the package repositories:</p>
            <p><code>
            sudo apt-get update
            </code></p>
            <p>Upgrade your server to the latest packages available:</p>
            <p><code>
            sudo apt-get upgrade
            </code></p>
            <p>Install the packages required to:</p>
            <ul>
                <li>build ruby</li>
                <li>connect to SQLite (optional) and PostgreSQL</li>
                <li>render JavaScript server-side (nodejs) with Rails</li>
                <li>serve static content with nginx</li>
            </ul>
            <p><code>
            sudo apt-get install build-essential nginx zlib1g-dev libssl-dev \<br>
                libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev \<br>
                libxslt1-dev libcurl4-openssl-dev libffi-dev nodejs libpq-dev
            </code></p>
            <h2>Install Ruby</h2>
            <p>Get the latest Ruby sources, built Ruby and install it:</p>
            <p><code>
            wget http://ftp.ruby-lang.org/pub/ruby/2.4/ruby-2.4.1.tar.gz<br>
            tar xf ruby-2.4.1.tar.gz<br>
            cd ruby-2.4.1/<br>
            ./configure<br>
            make<br>
            sudo make install
            </code></p>
            <p>At this point, <code>ruby -v</code> output should reflect the version you just installed.</p>

            <h2>Install Rails</h2>
            <p>Install the Rails version required by your application:</p>
            <p><code>
            sudo gem install rails -v 5.0.1
            </code></p>
            <p>At this point, <code>rails -v</code> output should reflect the version you just installed.</p>

            <h2>Prepare your Rails application</h2>
            <p>Get the sources of your Rails application on your server. From your application folder:</p>
            <ul>
                <li>install required gems</li>
                <li>prepare the production database</li>
                <li>prepare static assets</li>
            </ul>
            <p><code>
            bundle install<br>
            RAILS_ENV="production" bin/rails db:setup<br>
            RAILS_ENV=production bin/rails assets:precompile
            </code></p>
            <p>Setup the secret key by entering the following command and copying the result inside /etc/profile:</p>
            <p><code>
            RAILS_ENV=production rails secret
            </code></p>
            <p>Still in your application folder, create two folders that will be used by the puma server:</p>
            <p><code>
            mkdir tmp/sockets tmp/pids
            </code></p>

            <h2>Add a systemd service to run puma</h2>
            <p>Create a file named <code>rails-puma.service</code> inside <code>/lib/systemd/system/</code> with content similar to <a href="https://github.com/carlbolduc/carlbolduc.com/blob/master/samples/rails-puma.service">this</a>.</p>
            <p>Enable and start your new service:</p>
            <p><code>
            sudo systemctl enable rails-puma<br>
            sudo systemctl start rails-puma
            </code></p>


            <h2>Configure the nginx website</h2>
            <p>A site configuration similar to this will allow you to serve static assets through nginx while proxying application requests to puma. <a href="https://github.com/carlbolduc/carlbolduc.com/blob/master/samples/nginx.conf">This configuration</a> is for an https website which was configured through <a href="https://certbot.eff.org/#ubuntuxenial-nginx">certbot</a>.
            <p>Restart the nginx service:</p>
            <p><code>
            sudo systemctl restart nginx
            </code></p>
            <p>At this point, you are done and you should have your Rails application available at your domain name in https.</p>
        </main>
[% INCLUDE footer.tt2 %]
    </body>
</html>
